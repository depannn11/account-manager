<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Manager - User Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        :root{--primary:#4361ee;--primary-dark:#3a56d4;--secondary:#7209b7;--success:#4cc9f0;--danger:#f72585;--warning:#f8961e;--dark:#1a1a2e;--light:#f8f9fa;--gray:#6c757d;--gray-light:#e9ecef;--border-radius:12px;--box-shadow:0 10px 20px rgba(0,0,0,0.1);--transition:all 0.3s ease}
        body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);min-height:100vh}
        .navbar{background:white;padding:15px 30px;box-shadow:0 2px 10px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000}
        .navbar-left{display:flex;align-items:center;gap:20px}
        .burger-menu{display:none;flex-direction:column;gap:4px;cursor:pointer;padding:8px}
        .burger-line{width:25px;height:3px;background:var(--dark);border-radius:2px;transition:var(--transition)}
        .navbar-brand{display:flex;align-items:center;gap:15px}
        .navbar-brand i{font-size:1.8rem;color:var(--primary)}
        .navbar-brand h1{font-size:1.5rem;color:var(--dark);font-weight:700}
        .user-info{display:flex;align-items:center;gap:15px}
        .notification-badge{position:relative}
        .notification-btn{background:none;border:none;font-size:1.3rem;color:var(--gray);cursor:pointer;padding:8px;position:relative}
        .badge-count{position:absolute;top:0;right:0;background:var(--danger);color:white;font-size:0.7rem;padding:2px 6px;border-radius:10px;min-width:18px;text-align:center}
        .logout-btn{background:var(--primary);color:white;border:none;padding:8px 20px;border-radius:var(--border-radius);cursor:pointer;display:flex;align-items:center;gap:8px;font-weight:600;transition:var(--transition)}
        .logout-btn:hover{background:var(--primary-dark);transform:translateY(-2px)}
        .container{display:flex;min-height:calc(100vh - 70px)}
        .sidebar{width:280px;background:white;padding:25px 0;box-shadow:2px 0 10px rgba(0,0,0,0.1);transition:var(--transition)}
        .sidebar-menu{padding:0 20px}
        .menu-item{display:flex;align-items:center;gap:15px;padding:15px;margin-bottom:10px;border-radius:var(--border-radius);cursor:pointer;transition:var(--transition);color:var(--gray);text-decoration:none}
        .menu-item:hover{background:var(--gray-light);color:var(--primary)}
        .menu-item.active{background:var(--primary);color:white}
        .menu-item i{font-size:1.2rem;width:24px}
        .menu-item span{font-weight:600}
        .main-content{flex:1;padding:30px;overflow-y:auto}
        .section{display:none}
        .section.active{display:block}
        .card{background:white;border-radius:var(--border-radius);padding:30px;box-shadow:var(--box-shadow);margin-bottom:30px}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;flex-wrap:wrap;gap:15px}
        .card-header h2{color:var(--primary);font-size:1.5rem;font-weight:700}
        .btn{padding:12px 24px;border:none;border-radius:var(--border-radius);font-size:15px;font-weight:600;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;gap:8px}
        .btn-primary{background:linear-gradient(45deg,var(--primary),var(--secondary));color:white}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(67,97,238,0.3)}
        .form-group{margin-bottom:20px}
        label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark)}
        input,textarea{width:100%;padding:12px 15px;border:2px solid var(--gray-light);border-radius:var(--border-radius);font-size:15px;transition:var(--transition);resize:none}
        input:focus,textarea:focus{outline:none;border-color:var(--primary)}
        
        /* Chat UI Improvements */
        .chat-container{height:450px;overflow-y:auto;padding:20px;background:#f0f2f5;border-radius:var(--border-radius);margin-bottom:20px;display:flex;flex-direction:column;gap:12px;border:1px solid #e0e0e0}
        .message{max-width:75%;display:flex;flex-direction:column;animation: fadeIn 0.3s ease}
        .message.user{align-self:flex-end;align-items:flex-end}
        .message.admin{align-self:flex-start;align-items:flex-start}
        .message-content{padding:10px 16px;border-radius:18px;font-size:14.5px;line-height:1.4;box-shadow:0 1px 2px rgba(0,0,0,0.1);position:relative}
        .message.user .message-content{background:var(--primary);color:white;border-bottom-right-radius:2px}
        .message.admin .message-content{background:white;color:var(--dark);border-bottom-left-radius:2px}
        .message-time{font-size:0.7rem;color:var(--gray);margin-top:4px;padding:0 4px}
        
        .product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:25px;margin-top:20px}
        .product-card{background:white;border-radius:var(--border-radius);padding:20px;box-shadow:var(--box-shadow);border:1px solid #e9ecef;transition:var(--transition)}
        .product-card:hover{transform:translateY(-5px)}
        .result-box{background:#f8f9fa;border-radius:var(--border-radius);padding:25px;margin-top:25px;display:none;border:1px solid var(--gray-light)}
        .result-box.show{display:block}
        .notification{position:fixed;bottom:20px;right:20px;padding:15px 25px;border-radius:var(--border-radius);color:white;font-weight:600;box-shadow:var(--box-shadow);z-index:1001;display:none;align-items:center;gap:10px}
        .notification.success{background:var(--success)}
        .notification.error{background:var(--danger)}
        .overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999}
        @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
        @media(max-width:768px){.burger-menu{display:flex}.sidebar{position:fixed;left:-280px;top:70px;height:calc(100vh - 70px);z-index:1000}.sidebar.active{left:0}.overlay.active{display:block}.main-content{padding:20px 15px}}
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-left">
            <div class="burger-menu" id="burgerMenu">
                <div class="burger-line"></div>
                <div class="burger-line"></div>
                <div class="burger-line"></div>
            </div>
            <div class="navbar-brand">
                <i class="fas fa-user-shield"></i>
                <h1>User Panel</h1>
            </div>
        </div>
        <div class="user-info">
            <div class="notification-badge">
                <button class="notification-btn" id="notificationBtn">
                    <i class="fas fa-bell"></i>
                    <span class="badge-count" id="unreadCount">0</span>
                </button>
            </div>
            <span><strong id="userName">User</strong></span>
            <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </nav>

    <div class="overlay" id="overlay"></div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-menu">
                <a href="#" class="menu-item active" data-section="redeem"><i class="fas fa-gift"></i><span>Redeem Code</span></a>
                <a href="#" class="menu-item" data-section="products"><i class="fas fa-box"></i><span>Produk</span></a>
                <a href="#" class="menu-item" data-section="history"><i class="fas fa-history"></i><span>History</span></a>
                <a href="#" class="menu-item" data-section="chat"><i class="fas fa-comments"></i><span>Chat Admin</span><span class="badge-count" id="chatBadge" style="margin-left:auto;display:none;background:var(--danger);color:white;padding:2px 6px;border-radius:10px;font-size:0.7rem">0</span></a>
                <a href="#" class="menu-item" data-section="help"><i class="fas fa-question-circle"></i><span>Bantuan</span></a>
            </div>
        </div>

        <div class="main-content">
            <div class="section active" id="redeemSection">
                <div class="card">
                    <div class="card-header"><h2><i class="fas fa-gift"></i> Redeem Code</h2></div>
                    <form id="redeemForm">
                        <div class="form-group">
                            <label for="code"><i class="fas fa-key"></i> Masukkan Kode</label>
                            <input type="text" id="code" placeholder="Contoh: AMP-UWGSG1726" required>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-gift"></i> Redeem Akun</button>
                    </form>
                    <div class="result-box" id="resultBox">
                        <h2 style="color:var(--success);margin-bottom:15px"><i class="fas fa-check-circle"></i> Redeem Berhasil!</h2>
                        <div id="resultDetails"></div>
                        <button class="btn btn-primary" style="width:100%;margin-top:15px" id="copyAllBtn"><i class="fas fa-copy"></i> Salin Info</button>
                    </div>
                </div>
            </div>

            <div class="section" id="productsSection">
                <div class="card"><div class="card-header"><h2><i class="fas fa-box"></i> Produk</h2></div><div id="productsList"></div></div>
            </div>

            <div class="section" id="historySection">
                <div class="card"><div class="card-header"><h2><i class="fas fa-history"></i> Riwayat</h2></div><div id="redeemHistory"></div></div>
            </div>

            <div class="section" id="chatSection">
                <div class="card">
                    <div class="card-header"><h2><i class="fas fa-comments"></i> Chat Admin</h2></div>
                    <div class="chat-container" id="chatMessages"></div>
                    <form id="chatForm" style="display:flex;gap:10px">
                        <input type="text" id="chatMessage" placeholder="Tulis pesan..." required autocomplete="off">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>

            <div class="section" id="helpSection">
                <div class="card"><div class="card-header"><h2><i class="fas fa-question-circle"></i> Bantuan</h2></div><p>Silahkan hubungi admin via chat jika ada kendala.</p></div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        const storage = {
            get: (key) => localStorage.getItem(key),
            set: (key, val) => localStorage.setItem(key, val)
        };

        if (storage.get('userRole') !== 'user') window.location.href = 'index.html';
        document.getElementById('userName').textContent = storage.get('userName') || 'User';

        function showNotification(msg, type = 'success') {
            const el = document.getElementById('notification');
            el.textContent = msg;
            el.className = `notification ${type}`;
            el.style.display = 'flex';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        async function loadMessages() {
            try {
                const res = await fetch(`/api/messages?user_id=${storage.get('username')}`);
                const data = await res.json();
                const container = document.getElementById('chatMessages');
                const isAtBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 1;
                
                if (data.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:20px;color:gray">Belum ada pesan</div>';
                    return;
                }

                container.innerHTML = data.map(msg => `
                    <div class="message ${msg.role}">
                        <div class="message-content">${msg.message}</div>
                        <div class="message-time">${new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
                    </div>
                `).join('');

                if (isAtBottom) container.scrollTop = container.scrollHeight;
                
                const unread = data.filter(m => m.status === 'unread' && m.role === 'admin').length;
                document.getElementById('unreadCount').textContent = unread;
                document.getElementById('chatBadge').textContent = unread;
                document.getElementById('chatBadge').style.display = unread > 0 ? 'inline-block' : 'none';
            } catch (e) { console.error(e); }
        }

        document.getElementById('chatForm').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chatMessage');
            const msg = input.value.trim();
            if(!msg) return;

            try {
                const res = await fetch('/api/messages', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: storage.get('username'),
                        username: storage.get('userName'),
                        message: msg,
                        role: 'user'
                    })
                });
                if ((await res.json()).success) {
                    input.value = '';
                    loadMessages();
                }
            } catch (e) { showNotification('Gagal kirim', 'error'); }
        };

        function switchSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(id + 'Section').classList.add('active');
            document.querySelector(`[data-section="${id}"]`).classList.add('active');
            if(id === 'chat') {
                loadMessages();
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('overlay').classList.remove('active');
            }
        }

        document.querySelectorAll('.menu-item').forEach(m => {
            m.onclick = (e) => { e.preventDefault(); switchSection(m.dataset.section); };
        });

        document.getElementById('burgerMenu').onclick = () => {
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        };

        document.getElementById('overlay').onclick = () => {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        };

        document.getElementById('logoutBtn').onclick = () => { localStorage.clear(); window.location.href='index.html'; };

        // Initial
        setInterval(loadMessages, 5000);
        loadMessages();
    </script>
</body>
</html>

