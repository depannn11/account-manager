<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Manager - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        :root{--primary:#4361ee;--primary-dark:#3a56d4;--secondary:#7209b7;--danger:#f72585;--success:#4cc9f0;--warning:#f8961e;--dark:#1a1a2e;--light:#f8f9fa;--gray:#6c757d;--gray-light:#e9ecef;--border-radius:12px;--box-shadow:0 10px 20px rgba(0,0,0,0.1);--transition:all 0.3s cubic-bezier(0.25,0.8,0.25,1)}
        body{background:#f5f7fa;color:var(--dark);min-height:100vh}
        .navbar{background:white;padding:15px 30px;box-shadow:0 2px 10px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000}
        .navbar-left{display:flex;align-items:center;gap:20px}
        .burger-menu{display:none;flex-direction:column;gap:4px;cursor:pointer;padding:8px}
        .burger-line{width:25px;height:3px;background:var(--dark);border-radius:2px;transition:var(--transition)}
        .navbar-brand{display:flex;align-items:center;gap:15px}
        .navbar-brand i{font-size:1.8rem;color:var(--primary)}
        .navbar-brand h1{font-size:1.5rem;color:var(--dark);font-weight:700}
        .user-info{display:flex;align-items:center;gap:15px}
        .notification-badge{position:relative}
        .notification-btn{background:none;border:none;font-size:1.3rem;color:var(--gray);cursor:pointer;padding:8px;position:relative}
        .badge-count{position:absolute;top:0;right:0;background:var(--danger);color:white;font-size:0.7rem;padding:2px 6px;border-radius:10px;min-width:18px;text-align:center}
        .logout-btn{background:var(--danger);color:white;border:none;padding:8px 20px;border-radius:var(--border-radius);cursor:pointer;display:flex;align-items:center;gap:8px;font-weight:600;transition:var(--transition)}
        .logout-btn:hover{background:#e11570;transform:translateY(-2px)}
        .container{display:flex;min-height:calc(100vh - 70px)}
        .sidebar{width:280px;background:white;padding:25px 0;box-shadow:2px 0 10px rgba(0,0,0,0.1);transition:var(--transition)}
        .sidebar-menu{padding:0 20px}
        .menu-item{display:flex;align-items:center;gap:15px;padding:15px;margin-bottom:10px;border-radius:var(--border-radius);cursor:pointer;transition:var(--transition);color:var(--gray);text-decoration:none}
        .menu-item:hover{background:var(--gray-light);color:var(--primary)}
        .menu-item.active{background:var(--primary);color:white}
        .menu-item i{font-size:1.2rem;width:24px}
        .menu-item span{font-weight:600}
        .main-content{flex:1;padding:30px;overflow-y:auto}
        .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:25px;margin-bottom:40px}
        .stat-card{background:white;border-radius:var(--border-radius);padding:25px;box-shadow:var(--box-shadow);transition:var(--transition)}
        .stat-card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,0.15)}
        .stat-icon{width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:20px;font-size:1.5rem}
        .stat-icon.primary{background:rgba(67,97,238,0.1);color:var(--primary)}
        .stat-icon.success{background:rgba(76,201,240,0.1);color:var(--success)}
        .stat-icon.warning{background:rgba(248,150,30,0.1);color:var(--warning)}
        .stat-icon.danger{background:rgba(247,37,133,0.1);color:var(--danger)}
        .stat-value{font-size:2.2rem;font-weight:700;margin-bottom:5px}
        .stat-label{color:var(--gray);font-size:0.9rem}
        .card{background:white;border-radius:var(--border-radius);padding:30px;box-shadow:var(--box-shadow);margin-bottom:30px}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;flex-wrap:wrap;gap:15px}
        .card-header h2{color:var(--primary);font-size:1.5rem;font-weight:700}
        .btn{padding:12px 24px;border:none;border-radius:var(--border-radius);font-size:15px;font-weight:600;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;gap:8px}
        .btn-primary{background-color:var(--primary);color:white}
        .btn-primary:hover{background-color:var(--primary-dark);transform:translateY(-2px)}
        .btn-success{background-color:var(--success);color:white}
        .btn-success:hover{background-color:#3ab4d9}
        .btn-danger{background-color:var(--danger);color:white}
        .btn-danger:hover{background-color:#e11570}
        .btn-warning{background-color:var(--warning);color:white}
        .btn-warning:hover{background-color:#e6891b}
        table{width:100%;border-collapse:collapse;margin-top:20px}
        th,td{padding:15px;text-align:left;border-bottom:1px solid var(--gray-light)}
        th{background:var(--gray-light);font-weight:600;color:var(--dark)}
        tr:hover{background:rgba(67,97,238,0.05)}
        .badge{padding:5px 12px;border-radius:20px;font-size:0.8rem;font-weight:600}
        .badge.success{background:rgba(76,201,240,0.1);color:var(--success)}
        .badge.danger{background:rgba(247,37,133,0.1);color:var(--danger)}
        .badge.warning{background:rgba(248,150,30,0.1);color:var(--warning)}
        .badge.info{background:rgba(67,97,238,0.1);color:var(--primary)}
        .form-group{margin-bottom:20px}
        label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark)}
        input,select,textarea{width:100%;padding:12px 15px;border:2px solid var(--gray-light);border-radius:var(--border-radius);font-size:15px;transition:var(--transition)}
        input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary)}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;animation:fadeIn 0.3s ease-out}
        .modal-content{background:white;border-radius:var(--border-radius);width:90%;max-width:500px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,0.2)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .modal-header h3{color:var(--primary);font-size:1.5rem}
        .close-modal{background:none;border:none;font-size:1.8rem;color:var(--gray);cursor:pointer}
        .notification{position:fixed;bottom:20px;right:20px;padding:15px 25px;border-radius:var(--border-radius);color:white;font-weight:600;box-shadow:var(--box-shadow);z-index:1001;animation:slideInRight 0.3s ease-out;display:none;align-items:center;gap:10px}
        .notification.success{background:var(--success)}
        .notification.error{background:var(--danger)}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideInRight{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}
        .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:25px}
        .code-list{max-height:400px;overflow-y:auto}
        .code-item{background:var(--gray-light);padding:12px 15px;border-radius:var(--border-radius);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
        .code-text{font-family:monospace;font-weight:600;font-size:0.9rem}
        .copy-btn{background:var(--primary);color:white;border:none;padding:5px 15px;border-radius:var(--border-radius);cursor:pointer;font-size:0.8rem}
        .chat-container{max-height:400px;overflow-y:auto;padding:15px;background:var(--light);border-radius:var(--border-radius);margin-bottom:20px}
        .message{margin-bottom:15px;max-width:80%}
        .message.user{margin-left:auto}
        .message.admin{margin-right:auto}
        .message-content{padding:12px 15px;border-radius:var(--border-radius);box-shadow:0 2px 5px rgba(0,0,0,0.1)}
        .message.user .message-content{background:var(--primary);color:white}
        .message.admin .message-content{background:var(--gray-light);color:var(--dark)}
        .message-time{font-size:0.8rem;color:var(--gray);margin-top:5px}
        .empty-state{text-align:center;padding:40px;color:var(--gray)}
        .empty-state i{font-size:3rem;margin-bottom:15px;color:#e9ecef}
        .tab-navigation{display:flex;gap:10px;margin-bottom:30px;background:white;padding:10px;border-radius:var(--border-radius);box-shadow:var(--box-shadow);flex-wrap:wrap}
        .tab-btn{padding:12px 25px;border:none;background:none;border-radius:var(--border-radius);font-weight:600;cursor:pointer;transition:var(--transition)}
        .tab-btn.active{background:var(--primary);color:white}
        .tab-btn:hover:not(.active){background:var(--gray-light)}
        .section{display:none;animation:fadeIn 0.3s ease-out}
        .section.active{display:block}
        .overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:999}
        @media(max-width:992px){.grid-2{grid-template-columns:1fr}.container{padding:0}.main-content{padding:20px 15px}}
        @media(max-width:768px){.burger-menu{display:flex}.sidebar{position:fixed;left:-280px;top:70px;height:calc(100vh - 70px);z-index:1000}.sidebar.active{left:0}.overlay.active{display:block}.navbar-brand h1{font-size:1.2rem}.card-header{flex-direction:column;align-items:flex-start}.tab-navigation{overflow-x:auto;flex-wrap:nowrap}.tab-btn{padding:10px 15px;font-size:0.9rem}}
        @media(max-width:480px){.stat-card{padding:20px}.card{padding:20px}.btn{padding:10px 15px;font-size:14px}}
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-left">
            <div class="burger-menu" id="burgerMenu">
                <div class="burger-line"></div>
                <div class="burger-line"></div>
                <div class="burger-line"></div>
            </div>
            <div class="navbar-brand">
                <i class="fas fa-shield-alt"></i>
                <h1>Admin Panel</h1>
            </div>
        </div>
        <div class="user-info">
            <div class="notification-badge">
                <button class="notification-btn" id="notificationBtn">
                    <i class="fas fa-bell"></i>
                    <span class="badge-count" id="unreadCount">0</span>
                </button>
            </div>
            <span><strong id="adminName">Administrator</strong></span>
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </nav>

    <div class="overlay" id="overlay"></div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-menu">
                <a href="#" class="menu-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="menu-item" data-section="products">
                    <i class="fas fa-box"></i>
                    <span>Produk</span>
                </a>
                <a href="#" class="menu-item" data-section="accounts">
                    <i class="fas fa-user-shield"></i>
                    <span>Akun</span>
                </a>
                <a href="#" class="menu-item" data-section="codes">
                    <i class="fas fa-key"></i>
                    <span>Kode</span>
                </a>
                <a href="#" class="menu-item" data-section="chat">
                    <i class="fas fa-comments"></i>
                    <span>Chat</span>
                    <span class="badge danger" id="chatBadge" style="margin-left:auto;display:none">0</span>
                </a>
                <a href="#" class="menu-item" data-section="stats">
                    <i class="fas fa-chart-bar"></i>
                    <span>Statistik</span>
                </a>
            </div>
        </div>

        <div class="main-content">
            <div class="section active" id="dashboardSection">
                <h2 style="margin-bottom:30px;color:var(--primary)"><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                <div class="dashboard">
                    <div class="stat-card">
                        <div class="stat-icon primary"><i class="fas fa-box"></i></div>
                        <div class="stat-value" id="totalProducts">0</div>
                        <div class="stat-label">Total Produk</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success"><i class="fas fa-user-check"></i></div>
                        <div class="stat-value" id="totalAccounts">0</div>
                        <div class="stat-label">Total Akun</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning"><i class="fas fa-key"></i></div>
                        <div class="stat-value" id="availableAccounts">0</div>
                        <div class="stat-label">Akun Tersedia</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon danger"><i class="fas fa-code"></i></div>
                        <div class="stat-value" id="totalCodes">0</div>
                        <div class="stat-label">Kode Dibuat</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header"><h2><i class="fas fa-bolt"></i> Quick Actions</h2></div>
                        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px">
                            <button class="btn btn-primary" id="quickAddProduct"><i class="fas fa-plus"></i> Produk Baru</button>
                            <button class="btn btn-success" id="quickAddAccount"><i class="fas fa-user-plus"></i> Tambah Akun</button>
                            <button class="btn btn-warning" id="quickGenerateCode"><i class="fas fa-key"></i> Generate Kode</button>
                            <button class="btn btn-primary" id="quickCheckMessages"><i class="fas fa-comments"></i> Cek Pesan</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h2><i class="fas fa-history"></i> Aktivitas Terbaru</h2></div>
                        <div id="recentActivity"><p style="text-align:center;color:var(--gray);padding:20px">Memuat aktivitas...</p></div>
                    </div>
                </div>
            </div>

            <div class="section" id="productsSection">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-box"></i> Kelola Produk</h2>
                        <button class="btn btn-primary" id="addProductBtn"><i class="fas fa-plus"></i> Tambah Produk</button>
                    </div>
                    <div id="productsList"></div>
                </div>
            </div>

            <div class="section" id="accountsSection">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-user-shield"></i> Kelola Akun</h2>
                        <div style="display:flex;gap:15px;flex-wrap:wrap">
                            <select id="productSelect" style="min-width:200px"><option value="">Pilih Produk</option></select>
                            <button class="btn btn-primary" id="addAccountBtn"><i class="fas fa-plus"></i> Tambah Akun</button>
                            <button class="btn btn-success" id="importAccountsBtn"><i class="fas fa-file-import"></i> Import Bulk</button>
                        </div>
                    </div>
                    <div id="accountsList"></div>
                </div>
            </div>

            <div class="section" id="codesSection">
                <div class="tab-navigation">
                    <button class="tab-btn active" data-tab="generate">Generate Kode</button>
                    <button class="tab-btn" data-tab="manage">Kelola Kode</button>
                </div>
                <div class="section active" id="generateTab">
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header"><h2><i class="fas fa-key"></i> Generate Single Code</h2></div>
                            <form id="generateCodeForm">
                                <div class="form-group">
                                    <label>Pilih Produk</label>
                                    <select id="codeProductSelect" required><option value="">Pilih Produk</option></select>
                                </div>
                                <div class="form-group">
                                    <label>Pilih Akun</label>
                                    <select id="accountSelect" required><option value="">Pilih Akun</option></select>
                                </div>
                                <div class="form-group">
                                    <label>Custom Prefix (opsional)</label>
                                    <input type="text" id="customPrefix" placeholder="AMP" maxlength="6">
                                </div>
                                <button type="submit" class="btn btn-success" id="generateSingleBtn"><i class="fas fa-bolt"></i> Generate Kode</button>
                            </form>
                            <div id="singleCodeResult" style="margin-top:20px;display:none">
                                <div style="padding:15px;background:var(--light);border-radius:var(--border-radius);border-left:4px solid var(--success)">
                                    <h4 style="margin:0 0 10px 0;color:var(--success)"><i class="fas fa-check-circle"></i> Kode Berhasil Dibuat!</h4>
                                    <div style="font-family:monospace;font-size:1.2rem;font-weight:bold;padding:10px;background:white;border-radius:var(--border-radius);margin-bottom:10px" id="generatedCode"></div>
                                    <button class="btn btn-primary" onclick="copyGeneratedCode()"><i class="fas fa-copy"></i> Salin Kode</button>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h2><i class="fas fa-layer-group"></i> Generate Multiple Codes</h2></div>
                            <form id="generateMultipleForm">
                                <div class="form-group">
                                    <label>Pilih Produk</label>
                                    <select id="multipleProductSelect" required><option value="">Pilih Produk</option></select>
                                </div>
                                <div class="form-group">
                                    <label>Jumlah Kode</label>
                                    <input type="number" id="codeCount" min="1" max="50" value="5" required>
                                </div>
                                <div class="form-group">
                                    <label>Custom Prefix (opsional)</label>
                                    <input type="text" id="multipleCustomPrefix" placeholder="AMP" maxlength="6">
                                </div>
                                <button type="submit" class="btn btn-warning" id="generateMultipleBtn"><i class="fas fa-bolt"></i> Generate Multiple</button>
                            </form>
                            <div id="multipleCodeResult" style="margin-top:20px;display:none">
                                <div style="padding:15px;background:var(--light);border-radius:var(--border-radius);border-left:4px solid var(--warning)">
                                    <h4 style="margin:0 0 10px 0;color:var(--warning)"><i class="fas fa-check-circle"></i> Kode Berhasil Dibuat!</h4>
                                    <div style="max-height:200px;overflow-y:auto;padding:10px;background:white;border-radius:var(--border-radius);font-family:monospace;font-size:0.9rem" id="generatedCodesList"></div>
                                    <button class="btn btn-primary" onclick="copyAllCodes()" style="margin-top:10px"><i class="fas fa-copy"></i> Salin Semua Kode</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section" id="manageTab">
                    <div class="card">
                        <div class="card-header">
                            <h2><i class="fas fa-list"></i> Daftar Kode</h2>
                            <select id="viewCodeProductSelect" style="min-width:200px"><option value="">Pilih Produk</option></select>
                        </div>
                        <div class="code-list" id="codesList"></div>
                    </div>
                </div>
            </div>

            <div class="section" id="chatSection">
                <div class="card">
                    <div class="card-header"><h2><i class="fas fa-comments"></i> Chat dengan Users</h2></div>
                    <div class="chat-container" id="chatMessages"></div>
                    <form id="chatForm">
                        <div class="form-group">
                            <textarea id="chatMessage" rows="3" placeholder="Tulis pesan broadcast..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Kirim Pesan</button>
                    </form>
                </div>
            </div>

            <div class="section" id="statsSection">
                <div class="card">
                    <div class="card-header"><h2><i class="fas fa-chart-bar"></i> Statistik Detail</h2></div>
                    <div class="grid-2">
                        <div id="chartContainer"><canvas id="statsChart" width="400" height="300"></canvas></div>
                        <div>
                            <div class="stat-card" style="margin-bottom:15px">
                                <div class="stat-value" id="usedCodes">0</div>
                                <div class="stat-label">Kode Terpakai</div>
                            </div>
                            <div class="stat-card"><div class="stat-value" id="availableCodes">0</div><div class="stat-label">Kode Tersedia</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modalTitle">Produk</h3><button class="close-modal" id="closeProductModal">&times;</button></div>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group"><label>Kode Produk</label><input type="text" id="productCode" required></div>
                <div class="form-group"><label>Nama Produk</label><input type="text" id="productName" required></div>
                <div class="form-group"><label>Deskripsi</label><textarea id="productDescription"></textarea></div>
                <div class="form-group"><label>Icon</label><input type="text" id="productLogo" value="fas fa-box"></div>
                <div class="form-group"><label>Stok</label><input type="number" id="productStock" value="0"></div>
                <button type="submit" class="btn btn-primary">Simpan</button>
            </form>
        </div>
    </div>

    <div class="modal" id="accountModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Tambah Akun</h3><button class="close-modal" id="closeAccountModal">&times;</button></div>
            <form id="accountForm">
                <input type="hidden" id="accountProductId">
                <div class="form-group"><label>Email</label><input type="text" id="accountEmail" required></div>
                <div class="form-group"><label>Password</label><input type="text" id="accountPassword" required></div>
                <div class="form-group"><label>Login Via</label><select id="accountLoginVia"><option value="Email">Email</option><option value="Google">Google</option></select></div>
                <button type="submit" class="btn btn-primary">Simpan Akun</button>
            </form>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let products = [];
        let currentProductId = null;
        let lastGeneratedCode = '';
        let lastGeneratedCodes = [];

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('userRole') !== 'admin') window.location.href = 'index.html';
            document.getElementById('adminName').textContent = localStorage.getItem('userName') || 'Admin';
            initApp();
        });

        function initApp() {
            setupEventListeners();
            loadDashboard();
            loadProducts();
            loadMessages();
        }

        function setupEventListeners() {
            document.getElementById('logoutBtn').onclick = () => { localStorage.clear(); window.location.href = 'index.html'; };
            document.getElementById('burgerMenu').onclick = () => document.getElementById('sidebar').classList.toggle('active');
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.onclick = (e) => {
                    const section = item.getAttribute('data-section');
                    switchSection(section);
                }
            });

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => switchTab(btn.getAttribute('data-tab'));
            });

            // Form Submits
            document.getElementById('productForm').onsubmit = handleProductSubmit;
            document.getElementById('accountForm').onsubmit = handleAccountSubmit;
            document.getElementById('generateCodeForm').onsubmit = handleGenerateCodeSubmit;
            document.getElementById('generateMultipleForm').onsubmit = handleGenerateMultipleSubmit;
            document.getElementById('chatForm').onsubmit = handleChatSubmit;

            // Select Changes
            document.getElementById('productSelect').onchange = (e) => { currentProductId = e.target.value; loadAccounts(e.target.value); };
            document.getElementById('codeProductSelect').onchange = (e) => loadAvailableAccounts(e.target.value);
            document.getElementById('viewCodeProductSelect').onchange = (e) => loadCodes(e.target.value);

            // Modals
            document.getElementById('addProductBtn').onclick = () => openProductModal();
            document.getElementById('closeProductModal').onclick = () => document.getElementById('productModal').style.display='none';
            document.getElementById('addAccountBtn').onclick = () => openAccountModal();
            document.getElementById('closeAccountModal').onclick = () => document.getElementById('accountModal').style.display='none';
            
            // Quick actions
            document.getElementById('quickAddProduct').onclick = () => openProductModal();
            document.getElementById('quickAddAccount').onclick = () => openAccountModal();
            document.getElementById('quickGenerateCode').onclick = () => switchSection('codes');
        }

        function switchSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            document.getElementById(id + 'Section').classList.add('active');
            document.querySelector(`[data-section="${id}"]`).classList.add('active');
            if(id === 'stats') loadStats();
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('generateTab').classList.remove('active');
            document.getElementById('manageTab').classList.remove('active');
            document.querySelector(`[data-tab="${id}"]`).classList.add('active');
            document.getElementById(id + 'Tab').classList.add('active');
        }

        function showNotification(msg, type='success') {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.className = `notification ${type}`;
            n.style.display = 'flex';
            setTimeout(() => n.style.display = 'none', 3000);
        }

        // --- API LOADERS ---
        async function loadDashboard() {
            const res = await fetch('/api/stats');
            const data = await res.json();
            document.getElementById('totalProducts').textContent = data.products || 0;
            document.getElementById('totalAccounts').textContent = data.totalAccounts || 0;
            document.getElementById('availableAccounts').textContent = data.availableAccounts || 0;
            document.getElementById('totalCodes').textContent = data.totalCodes || 0;
        }

        async function loadProducts() {
            const res = await fetch('/api/products');
            products = await res.json();
            const list = document.getElementById('productsList');
            list.innerHTML = `<table><thead><tr><th>Kode</th><th>Nama</th><th>Aksi</th></tr></thead><tbody>
                ${products.map(p => `<tr><td>${p.product_code}</td><td>${p.name}</td>
                <td><button onclick="deleteProduct(${p.id})" class="btn-danger">Hapus</button></td></tr>`).join('')}
            </tbody></table>`;
            
            // Update Selects
            const selects = ['productSelect', 'codeProductSelect', 'multipleProductSelect', 'viewCodeProductSelect'];
            selects.forEach(s => {
                const el = document.getElementById(s);
                el.innerHTML = '<option value="">Pilih Produk</option>' + products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            });
        }

        async function loadAccounts(pid) {
            if(!pid) return;
            const res = await fetch(`/api/products/${pid}/accounts`);
            const accounts = await res.json();
            document.getElementById('accountsList').innerHTML = `<table><thead><tr><th>Email</th><th>Status</th></tr></thead><tbody>
                ${accounts.map(a => `<tr><td>${a.email}</td><td>${a.status}</td></tr>`).join('')}
            </tbody></table>`;
        }

        async function loadAvailableAccounts(pid) {
            const res = await fetch(`/api/products/${pid}/available-accounts`);
            const accs = await res.json();
            document.getElementById('accountSelect').innerHTML = '<option value="">Pilih Akun</option>' + accs.map(a => `<option value="${a.id}">${a.email}</option>`).join('');
        }

        async function loadCodes(pid) {
            if(!pid) return;
            const res = await fetch(`/api/codes/${pid}`);
            const codes = await res.json();
            document.getElementById('codesList').innerHTML = codes.map(c => `
                <div class="code-item"><span>${c.code}</span><button onclick="copyToClipboard('${c.code}')" class="copy-btn">Salin</button></div>
            `).join('');
        }

        // --- HANDLERS ---
        async function handleProductSubmit(e) {
            e.preventDefault();
            const body = {
                product_code: document.getElementById('productCode').value,
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                logo: document.getElementById('productLogo').value,
                stock: document.getElementById('productStock').value
            };
            await fetch('/api/products', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)});
            document.getElementById('productModal').style.display='none';
            loadProducts();
        }

        async function handleAccountSubmit(e) {
            e.preventDefault();
            const body = {
                product_id: document.getElementById('accountProductId').value,
                email: document.getElementById('accountEmail').value,
                password: document.getElementById('accountPassword').value,
                login_via: document.getElementById('accountLoginVia').value
            };
            await fetch('/api/accounts', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)});
            document.getElementById('accountModal').style.display='none';
            loadAccounts(body.product_id);
        }

        // --- FIXED GENERATE CODE FUNCTIONS ---
        async function handleGenerateCodeSubmit(e) {
            e.preventDefault();
            const pid = document.getElementById('codeProductSelect').value;
            const aid = document.getElementById('accountSelect').value;
            const prefix = document.getElementById('customPrefix').value.trim();
            
            const btn = document.getElementById('generateSingleBtn');
            btn.disabled = true;

            try {
                const res = await fetch('/api/codes/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ product_id: pid, account_id: aid, custom_prefix: prefix || "AMP" })
                });
                const data = await res.json();
                if(data.success) {
                    lastGeneratedCode = data.code;
                    document.getElementById('generatedCode').textContent = data.code;
                    document.getElementById('singleCodeResult').style.display = 'block';
                    showNotification('Kode berhasil dibuat');
                    loadDashboard();
                    loadAvailableAccounts(pid);
                } else {
                    showNotification(data.error, 'error');
                }
            } catch(e) { showNotification('Gagal terhubung ke server', 'error'); }
            finally { btn.disabled = false; }
        }

        async function handleGenerateMultipleSubmit(e) {
            e.preventDefault();
            const pid = document.getElementById('multipleProductSelect').value;
            const count = document.getElementById('codeCount').value;
            const prefix = document.getElementById('multipleCustomPrefix').value.trim();
            
            const btn = document.getElementById('generateMultipleBtn');
            btn.disabled = true;

            try {
                const res = await fetch('/api/codes/generate-multiple', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ product_id: pid, count: count, custom_prefix: prefix || "AMP" })
                });
                const data = await res.json();
                if(data.success) {
                    lastGeneratedCodes = data.codes;
                    document.getElementById('generatedCodesList').innerHTML = data.codes.map(c => `<div>${c.code}</div>`).join('');
                    document.getElementById('multipleCodeResult').style.display = 'block';
                    showNotification(count + ' Kode berhasil dibuat');
                    loadDashboard();
                } else {
                    showNotification(data.error, 'error');
                }
            } catch(e) { showNotification('Gagal terhubung', 'error'); }
            finally { btn.disabled = false; }
        }

        // --- UTILS ---
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            showNotification('Berhasil disalin');
        }
        function copyGeneratedCode() { copyToClipboard(lastGeneratedCode); }
        function copyAllCodes() { copyToClipboard(lastGeneratedCodes.map(c => c.code).join('\n')); }

        function openProductModal() { document.getElementById('productModal').style.display='flex'; }
        function openAccountModal() { 
            const pid = document.getElementById('productSelect').value;
            if(!pid) return showNotification('Pilih produk dulu', 'error');
            document.getElementById('accountProductId').value = pid;
            document.getElementById('accountModal').style.display='flex'; 
        }

        async function deleteProduct(id) {
            if(!confirm('Hapus produk ini?')) return;
            await fetch(`/api/products/${id}`, { method: 'DELETE' });
            loadProducts();
        }

        async function loadMessages() {
            const res = await fetch('/api/messages');
            const msgs = await res.json();
            document.getElementById('chatMessages').innerHTML = msgs.map(m => `
                <div class="message ${m.role}"><div class="message-content"><strong>${m.username}:</strong> ${m.message}</div></div>
            `).join('');
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const msg = document.getElementById('chatMessage').value;
            await fetch('/api/messages', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: 'broadcast', username: 'Admin', message: msg, role: 'admin' })
            });
            document.getElementById('chatMessage').value = '';
            loadMessages();
        }
    </script>
</body>
</html>
